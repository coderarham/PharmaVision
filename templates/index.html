<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Medicines Dataset Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 30px; }
        .section { background: white; margin: 20px 0; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section h2 { color: #333; margin-bottom: 20px; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .chart-container { position: relative; height: 400px; margin: 20px 0; }
        .table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .table th, .table td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        .table th { background: #667eea; color: white; }
        .table tr:hover { background: #f5f5f5; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-value { font-size: 2em; font-weight: bold; }
        .loading { text-align: center; padding: 50px; color: #666; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .search-container { position: relative; margin: 20px 0; }
        .search-box { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #667eea; border-radius: 10px; outline: none; }
        .search-box:focus { border-color: #764ba2; box-shadow: 0 0 10px rgba(102, 126, 234, 0.3); }
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f5f5f5; }
        .search-results { margin: 20px 0; }
        .medicine-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .medicine-name { font-weight: bold; color: #667eea; font-size: 18px; }
        .medicine-details { margin: 5px 0; color: #666; }
        .price-tag { background: #667eea; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; }
        .discontinued { background: #ff5722; }
        .filter-btn, .clear-btn { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; }
        .filter-btn:hover, .clear-btn:hover { background: #764ba2; }
        .company-select { padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; min-width: 200px; }
        .active-filter { background: #ff5722 !important; }
        .medicine-card { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .medicine-card:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 15px; width: 80%; max-width: 600px; max-height: 80%; overflow-y: auto; position: relative; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 20px; top: 15px; }
        .close:hover { color: #667eea; }
        .detail-header { border-bottom: 3px solid #667eea; padding-bottom: 15px; margin-bottom: 20px; }
        .detail-title { color: #667eea; font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .detail-section { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .detail-label { font-weight: bold; color: #333; margin-bottom: 5px; }
        .detail-value { color: #666; margin-bottom: 10px; }
        .composition-item { background: #e3f2fd; padding: 8px 12px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #667eea; }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header { padding: 20px 15px; }
            .header h1 { font-size: 1.5em; }
            .section { padding: 15px; margin: 15px 0; }
            .search-box { padding: 12px; font-size: 16px; }
            .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.5em; }
            .chart-container { height: 300px; }
            .table { font-size: 14px; }
            .table th, .table td { padding: 8px 4px; }
            .medicine-card { padding: 12px; margin: 8px 0; }
            .medicine-name { font-size: 16px; }
            .medicine-details { font-size: 14px; }
            .price-tag { padding: 4px 8px; font-size: 12px; }
            .filter-btn, .clear-btn { padding: 8px 15px; font-size: 13px; }
            .company-select { min-width: 150px; padding: 8px; }
            .modal-content { width: 95%; margin: 10% auto; padding: 20px; }
            .detail-title { font-size: 20px; }
            .detail-section { padding: 12px; }
            div[style*="display: flex"] { flex-direction: column; gap: 10px !important; align-items: stretch !important; }
        }
        
        @media (max-width: 480px) {
            .header h1 { font-size: 1.3em; }
            .section h2 { font-size: 1.2em; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
            .table { font-size: 12px; }
            .table th, .table td { padding: 6px 2px; }
            .medicine-name { font-size: 15px; }
            .medicine-details { font-size: 13px; }
            .chart-container { height: 250px; }
            .modal-content { width: 98%; margin: 5% auto; padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• Indian Medicines Dataset Analysis</h1>
            <p>Comprehensive analysis of pharmaceutical data in India</p>
            
            <div class="search-container">
                <input type="text" id="searchBox" class="search-box" placeholder="Search medicines, manufacturers, or compositions..." autocomplete="off">
                
                <div class="filter-controls" style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
                    <button id="filterBtn" class="filter-btn">üè≠ Filter by Company</button>
                    <select id="companyFilter" class="company-select" style="display: none;">
                        <option value="">All Companies</option>
                    </select>
                    <button id="clearFilter" class="clear-btn" style="display: none;">Clear Filter</button>
                </div>
            </div>
        </div>
        
        <div id="searchResults" class="search-results" style="display: none;">
            <div class="section">
                <h2 id="searchResultsTitle">üîç Search Results</h2>
                <div id="searchResultsContent"></div>
            </div>
        </div>
        
        <!-- Medicine Detail Modal -->
        <div id="medicineModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <div id="medicineDetails"></div>
            </div>
        </div>

        <div id="summary-section" class="section">
            <h2>üìä Dataset Summary</h2>
            <div id="summary-stats" class="stats-grid">
                <div class="loading">Loading summary...</div>
            </div>
        </div>

        <div class="section">
            <h2>üè≠ Top 15 Manufacturers</h2>
            <div class="chart-container">
                <canvas id="manufacturersChart"></canvas>
            </div>
        </div>

        <div class="section">
            <h2>üíä Paracetamol Medicines Price Comparison</h2>
            <div id="paracetamol-table">
                <div class="loading">Loading paracetamol data...</div>
            </div>
        </div>

        <div class="section">
            <h2>üí∞ Price Analysis</h2>
            <h3>Most Expensive Medicines</h3>
            <div id="expensive-table">
                <div class="loading">Loading expensive medicines...</div>
            </div>
            <h3>Cheapest Medicines</h3>
            <div id="cheapest-table">
                <div class="loading">Loading cheapest medicines...</div>
            </div>
            <h3>Price Distribution</h3>
            <div class="chart-container">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <div class="section">
            <h2>ü©∫ Diabetes Medicines</h2>
            <div id="diabetes-table">
                <div class="loading">Loading diabetes medicines...</div>
            </div>
        </div>

        <div class="section">
            <h2>üß™ Top 15 Chemical Compositions</h2>
            <div class="chart-container">
                <canvas id="compositionsChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Utility function to create tables
        function createTable(data, columns) {
            let html = '<table class="table"><thead><tr>';
            columns.forEach(col => html += `<th>${col}</th>`);
            html += '</tr></thead><tbody>';
            
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col] || '';
                    if ((col.includes('price') || col.includes('Price')) && typeof value === 'number') {
                        value = '‚Çπ' + value.toFixed(2);
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Load summary data
        fetch('/api/summary')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('summary-stats').innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                document.getElementById('summary-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${data.total_medicines.toLocaleString()}</div>
                        <div>Total Medicines</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.total_manufacturers}</div>
                        <div>Manufacturers</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Çπ${data.avg_price}</div>
                        <div>Average Price</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Çπ${data.min_price} - ‚Çπ${data.max_price}</div>
                        <div>Price Range</div>
                    </div>
                `;
            })
            .catch(error => {
                document.getElementById('summary-stats').innerHTML = `<div class="error">Error loading summary: ${error}</div>`;
            });

        // Load manufacturers chart
        fetch('/api/manufacturers')
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                const ctx = document.getElementById('manufacturersChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Number of Medicines',
                            data: data.data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });

        // Load paracetamol data
        fetch('/api/paracetamol')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('paracetamol-table').innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                document.getElementById('paracetamol-table').innerHTML = 
                    createTable(data.medicines, ['name', 'manufacturer_name', 'price(‚Çπ)']);
            });

        // Load price analysis
        fetch('/api/price-stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                document.getElementById('expensive-table').innerHTML = 
                    createTable(data.expensive, ['name', 'manufacturer_name', 'price(‚Çπ)']);
                
                document.getElementById('cheapest-table').innerHTML = 
                    createTable(data.cheapest, ['name', 'manufacturer_name', 'price(‚Çπ)']);

                // Price distribution chart
                const ctx = document.getElementById('priceChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 20}, (_, i) => `${i * 50}-${(i + 1) * 50}`),
                        datasets: [{
                            label: 'Number of Medicines',
                            data: Array.from({length: 20}, (_, i) => 
                                data.price_distribution.filter(p => p >= i * 50 && p < (i + 1) * 50).length
                            ),
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderColor: 'rgba(118, 75, 162, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });

        // Load diabetes medicines
        fetch('/api/diabetes')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('diabetes-table').innerHTML = `<div class="error">${data.error}</div>`;
                    return;
                }
                
                document.getElementById('diabetes-table').innerHTML = 
                    createTable(data.medicines, ['name', 'manufacturer_name', 'short_composition1']);
            });

        // Load compositions chart
        fetch('/api/compositions')
            .then(response => response.json())
            .then(data => {
                if (data.error) return;
                
                const ctx = document.getElementById('compositionsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels.map(label => label.length > 30 ? label.substring(0, 30) + '...' : label),
                        datasets: [{
                            label: 'Frequency',
                            data: data.data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true },
                            x: { 
                                ticks: { 
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
            });
        
        // Search functionality
        const searchBox = document.getElementById('searchBox');
        const searchResults = document.getElementById('searchResults');
        const searchResultsContent = document.getElementById('searchResultsContent');
        const filterBtn = document.getElementById('filterBtn');
        const companyFilter = document.getElementById('companyFilter');
        const clearFilter = document.getElementById('clearFilter');
        const searchResultsTitle = document.getElementById('searchResultsTitle');
        
        let searchTimeout;
        let currentMode = 'none'; // 'search', 'filter', 'none'
        
        searchBox.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query.length < 1) {
                searchResults.style.display = 'none';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 100);
        });
        
        searchBox.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(searchTimeout);
            }
        });
        
        function performSearch(query) {
            if (query.length < 1) return;
            
            currentMode = 'search';
            companyFilter.value = ''; // Clear filter when searching
            
            searchResultsContent.innerHTML = '<div class="loading">Searching...</div>';
            searchResults.style.display = 'block';
            
            fetch(`/api/search?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (currentMode !== 'search') return; // Prevent race conditions
                    
                    if (data.error) {
                        searchResultsContent.innerHTML = `<div class="error">${data.error}</div>`;
                        return;
                    }
                    
                    if (data.medicines.length === 0) {
                        searchResultsContent.innerHTML = '<div class="loading">No medicines found matching your search.</div>';
                        return;
                    }
                    
                    const resultsHtml = data.medicines.map(medicine => `
                        <div class="medicine-card">
                            <div class="medicine-name">${medicine.name}</div>
                            <div class="medicine-details">
                                <strong>Manufacturer:</strong> ${medicine.manufacturer}
                            </div>
                            <div class="medicine-details">
                                <strong>Composition:</strong> ${medicine.composition}
                            </div>
                            <div class="medicine-details">
                                <strong>Pack Size:</strong> ${medicine.pack_size}
                            </div>
                            <div class="medicine-details">
                                <strong>Type:</strong> ${medicine.type}
                                <span class="price-tag ${medicine.discontinued ? 'discontinued' : ''}">
                                    ‚Çπ${medicine.price.toFixed(2)} ${medicine.discontinued ? '(Discontinued)' : ''}
                                </span>
                            </div>
                        </div>
                    `).join('');
                    
                    searchResultsTitle.textContent = 'üîç Search Results';
                    searchResultsContent.innerHTML = `
                        <p><strong>${data.medicines.length} medicines found</strong></p>
                        ${resultsHtml}
                    `;
                })
                .catch(error => {
                    if (currentMode === 'search') {
                        searchResultsContent.innerHTML = `<div class="error">Error performing search: ${error}</div>`;
                    }
                });
        }
        
        // Load companies for filter
        fetch('/api/companies')
            .then(response => response.json())
            .then(data => {
                if (data.companies) {
                    data.companies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        companyFilter.appendChild(option);
                    });
                }
            });
        
        // Filter button functionality
        filterBtn.addEventListener('click', function() {
            if (companyFilter.style.display === 'none') {
                companyFilter.style.display = 'block';
                clearFilter.style.display = 'block';
                filterBtn.textContent = 'üè≠ Hide Filter';
                filterBtn.classList.add('active-filter');
            } else {
                companyFilter.style.display = 'none';
                clearFilter.style.display = 'none';
                filterBtn.textContent = 'üè≠ Filter by Company';
                filterBtn.classList.remove('active-filter');
            }
        });
        
        // Company filter change
        companyFilter.addEventListener('change', function() {
            const selectedCompany = this.value;
            if (selectedCompany) {
                searchBox.value = ''; // Clear search when filtering
                filterByCompany(selectedCompany);
            } else {
                searchResults.style.display = 'none';
                currentMode = 'none';
            }
        });
        
        // Clear filter
        clearFilter.addEventListener('click', function() {
            companyFilter.value = '';
            searchBox.value = '';
            searchResults.style.display = 'none';
            companyFilter.style.display = 'none';
            clearFilter.style.display = 'none';
            filterBtn.textContent = 'üè≠ Filter by Company';
            filterBtn.classList.remove('active-filter');
            currentMode = 'none';
        });
        
        function filterByCompany(company) {
            currentMode = 'filter';
            
            searchResultsContent.innerHTML = '<div class="loading">Loading medicines...</div>';
            searchResults.style.display = 'block';
            searchResultsTitle.textContent = `üè≠ ${company} - Medicines`;
            
            fetch(`/api/filter-by-company?company=${encodeURIComponent(company)}`)
                .then(response => response.json())
                .then(data => {
                    if (currentMode !== 'filter') return; // Prevent race conditions
                    
                    if (data.error) {
                        searchResultsContent.innerHTML = `<div class="error">${data.error}</div>`;
                        return;
                    }
                    
                    if (data.medicines.length === 0) {
                        searchResultsContent.innerHTML = '<div class="loading">No medicines found for this company.</div>';
                        return;
                    }
                    
                    const resultsHtml = data.medicines.map(medicine => `
                        <div class="medicine-card">
                            <div class="medicine-name">${medicine.name}</div>
                            <div class="medicine-details">
                                <strong>Composition:</strong> ${medicine.composition}
                            </div>
                            <div class="medicine-details">
                                <strong>Pack Size:</strong> ${medicine.pack_size}
                            </div>
                            <div class="medicine-details">
                                <strong>Type:</strong> ${medicine.type}
                                <span class="price-tag ${medicine.discontinued ? 'discontinued' : ''}">
                                    ‚Çπ${medicine.price.toFixed(2)} ${medicine.discontinued ? '(Discontinued)' : ''}
                                </span>
                            </div>
                        </div>
                    `).join('');
                    
                    searchResultsContent.innerHTML = `
                        <p><strong>${data.medicines.length} medicines shown (Total: ${data.total_count})</strong></p>
                        ${resultsHtml}
                    `;
                })
                .catch(error => {
                    if (currentMode === 'filter') {
                        searchResultsContent.innerHTML = `<div class="error">Error loading company medicines: ${error}</div>`;
                    }
                });
        }
        
        // Modal functionality
        closeModal.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        function showMedicineDetails(medicineName) {
            modalContent.innerHTML = '<div class="loading">Loading medicine details...</div>';
            modal.style.display = 'block';
            
            fetch(`/api/medicine-details?name=${encodeURIComponent(medicineName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        modalContent.innerHTML = `<div class="error">${data.error}</div>`;
                        return;
                    }
                    
                    const compositionHtml = `
                        <div class="composition-item">
                            <strong>Primary:</strong> ${data.composition1}
                        </div>
                        ${data.composition2 ? `<div class="composition-item"><strong>Secondary:</strong> ${data.composition2}</div>` : ''}
                    `;
                    
                    const similarHtml = data.similar_medicines.length > 0 ? `
                        <div class="detail-section">
                            <div class="detail-label">üè¢ Similar Medicines from ${data.manufacturer}</div>
                            ${data.similar_medicines.map(med => `
                                <div style="padding: 8px; border-bottom: 1px solid #eee;">
                                    <strong>${med.name}</strong> - ‚Çπ${med.price.toFixed(2)} (${med.pack_size})
                                </div>
                            `).join('')}
                        </div>
                    ` : '';
                    
                    const compSimilarHtml = data.composition_similar.length > 0 ? `
                        <div class="detail-section">
                            <div class="detail-label">üß™ Same Composition Medicines</div>
                            ${data.composition_similar.map(med => `
                                <div style="padding: 8px; border-bottom: 1px solid #eee;">
                                    <strong>${med.name}</strong> by ${med.manufacturer} - ‚Çπ${med.price.toFixed(2)}
                                </div>
                            `).join('')}
                        </div>
                    ` : '';
                    
                    modalContent.innerHTML = `
                        <div class="detail-header">
                            <div class="detail-title">${data.name}</div>
                            <div style="color: #666;">üè¢ ${data.manufacturer}</div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-label">üß™ Chemical Composition</div>
                            ${compositionHtml}
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-label">üí∞ Price Information</div>
                            <div class="detail-value">
                                <span class="price-tag ${data.discontinued ? 'discontinued' : ''}" style="font-size: 18px;">
                                    ‚Çπ${data.price.toFixed(2)} ${data.discontinued ? '(Discontinued)' : ''}
                                </span>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <div class="detail-label">üì¶ Package Details</div>
                            <div class="detail-value"><strong>Pack Size:</strong> ${data.pack_size}</div>
                            <div class="detail-value"><strong>Type:</strong> ${data.type}</div>
                            <div class="detail-value"><strong>Medicine ID:</strong> ${data.id}</div>
                        </div>
                        
                        ${similarHtml}
                        ${compSimilarHtml}
                    `;
                })
                .catch(error => {
                    modalContent.innerHTML = `<div class="error">Error loading medicine details: ${error}</div>`;
                });
        }
    </script>
</body>
</html>